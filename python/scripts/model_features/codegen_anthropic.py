"""Code generation for Anthropic model info from test results.

This script reads the anthropic.yaml feature test results and generates
python/mirascope/llm/providers/anthropic/model_info.py with:
- AnthropicKnownModels type alias containing all valid model IDs

Logic:
- For each discovered model with a date suffix (e.g., claude-3-5-haiku-20241022),
  generates three variants:
  1. The dated version: "anthropic/claude-3-5-haiku-20241022"
  2. The -latest alias: "anthropic/claude-3-5-haiku-latest"
  3. The base name without suffix: "anthropic/claude-3-5-haiku"
- For models without date suffixes, just adds the model as-is
- Models are sorted alphabetically for consistency

Usage:
    uv run python -m scripts.model_features.codegen_anthropic
"""

import re
import sys
from pathlib import Path
from typing import Any

import yaml


def load_yaml(path: Path) -> dict[str, Any]:
    """Load YAML file."""
    with open(path) as f:
        return yaml.safe_load(f)


def generate_model_info(data: dict[str, Any]) -> str:
    """Generate the model_info.py file content."""
    model_ids: set[str] = set()

    # Pattern to match date suffixes like -20241022
    date_pattern = re.compile(r"-(\d{8})$")

    for model_id in data.get("models", {}):
        # Check if model has a date suffix
        match = date_pattern.search(model_id)

        if match:
            # Model has a date suffix - generate all three variants
            base_name = model_id[: match.start()]  # Remove date suffix

            # Add dated version
            model_ids.add(f"anthropic/{model_id}")

            # Add -latest alias
            model_ids.add(f"anthropic/{base_name}-latest")

            # Add base name without suffix
            model_ids.add(f"anthropic/{base_name}")
        else:
            # Model without date suffix - add as-is
            model_ids.add(f"anthropic/{model_id}")

    # Sort for consistent output
    sorted_model_ids = sorted(model_ids)

    # Generate the file content
    lines = [
        '"""Anthropic model information.',
        "",
        "This file is auto-generated by scripts/model_features/codegen_anthropic.py",
        'Do not edit manually - run the codegen script to update."""',
        "",
        "from typing import Literal",
        "",
        "AnthropicKnownModels = Literal[",
    ]

    # Add model IDs as literal strings
    for i, model_id in enumerate(sorted_model_ids):
        comma = "," if i < len(sorted_model_ids) - 1 else ""
        lines.append(f'    "{model_id}"{comma}')

    lines.append("]")
    lines.append('"""Valid Anthropic model IDs."""')
    lines.append("")

    return "\n".join(lines)


def main() -> int:
    # Setup paths
    script_dir = Path(__file__).parent
    input_path = script_dir / "data" / "anthropic.yaml"
    output_path = (
        script_dir.parent.parent
        / "mirascope"
        / "llm"
        / "providers"
        / "anthropic"
        / "model_info.py"
    )

    # Check input exists
    if not input_path.exists():
        print(f"Error: Input file not found: {input_path}")
        print("Run test_anthropic.py first to generate test results")
        return 1

    # Load YAML
    print(f"Reading test results from: {input_path}")
    data = load_yaml(input_path)

    # Generate code
    print("Generating model info...")
    content = generate_model_info(data)

    # Write file
    output_path.parent.mkdir(parents=True, exist_ok=True)
    output_path.write_text(content)
    print(f"Generated: {output_path}")

    # Show stats
    lines = content.split("\n")
    model_count = sum(1 for line in lines if line.strip().startswith('"anthropic/'))
    print(f"  Total model IDs: {model_count}")

    return 0


if __name__ == "__main__":
    sys.exit(main())
