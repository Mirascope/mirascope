name: Cleanup Cloud PR Preview

on:
  pull_request:
    branches: [v2]
    types: [closed]
    paths:
      - 'cloud/**'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PlanetScale CLI
        uses: planetscale/setup-pscale-action@v1

      - name: Delete PlanetScale Branch
        env:
          PLANETSCALE_SERVICE_TOKEN_ID: ${{ secrets.PLANETSCALE_SERVICE_TOKEN_ID }}
          PLANETSCALE_SERVICE_TOKEN: ${{ secrets.PLANETSCALE_SERVICE_TOKEN }}
        run: |
          pscale branch delete ${{ vars.PLANETSCALE_DATABASE }} preview-pr-${{ github.event.number }} --org ${{ vars.PLANETSCALE_ORG }} --force || true
        continue-on-error: true

      - name: Delete ClickHouse Database
        env:
          CLICKHOUSE_HOST: ${{ secrets.STAGING_CLICKHOUSE_HOST }}
          CLICKHOUSE_USER: ${{ secrets.STAGING_CLICKHOUSE_USER }}
          CLICKHOUSE_PASSWORD: ${{ secrets.STAGING_CLICKHOUSE_PASSWORD }}
        run: |
          DB_NAME="preview_pr_${{ github.event.number }}"

          echo "Dropping ClickHouse database: $DB_NAME"

          curl -X POST "https://${CLICKHOUSE_HOST}:8443/" \
            --user "${CLICKHOUSE_USER}:${CLICKHOUSE_PASSWORD}" \
            --data-binary "DROP DATABASE IF EXISTS ${DB_NAME}" || true
        continue-on-error: true

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Delete Hyperdrive config
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd cloud
          HYPERDRIVE_NAME="mirascope-cloud-pr-${{ github.event.number }}"
          HYPERDRIVE_ID=$(bunx wrangler hyperdrive list --json 2>/dev/null | jq -r ".[] | select(.name == \"$HYPERDRIVE_NAME\") | .id" || echo "")

          if [ -n "$HYPERDRIVE_ID" ]; then
            bunx wrangler hyperdrive delete $HYPERDRIVE_ID --yes || true
          fi
        continue-on-error: true

      - name: Delete Cloudflare Worker
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        run: |
          cd cloud
          bunx wrangler delete --name mirascope-cloud-pr-${{ github.event.number }} --force || true
        continue-on-error: true

  deploy-staging-on-merge:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: cloud
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run database migrations
        run: bun run db:migrate
        env:
          DATABASE_URL: ${{ secrets.STAGING_DATABASE_URL }}

      - name: Build for staging
        run: bun run build

      - name: Deploy to Cloudflare Workers (Staging)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: cloud
          command: deploy --env staging
          postCommands: |
            echo "Setting staging worker secrets..."
            echo "${{ secrets.STAGING_GITHUB_CLIENT_SECRET }}" | bunx wrangler secret put GITHUB_CLIENT_SECRET --env staging
            echo "${{ secrets.STAGING_GOOGLE_CLIENT_SECRET }}" | bunx wrangler secret put GOOGLE_CLIENT_SECRET --env staging
            echo "${{ secrets.STAGING_RESEND_API_KEY }}" | bunx wrangler secret put RESEND_API_KEY --env staging
            echo "${{ secrets.STAGING_RESEND_AUDIENCE_SEGMENT_ID }}" | bunx wrangler secret put RESEND_AUDIENCE_SEGMENT_ID --env staging
            echo "${{ secrets.STAGING_STRIPE_SECRET_KEY }}" | bunx wrangler secret put STRIPE_SECRET_KEY --env staging
            echo "${{ secrets.STAGING_STRIPE_WEBHOOK_SECRET }}" | bunx wrangler secret put STRIPE_WEBHOOK_SECRET --env staging
            echo "${{ secrets.STAGING_ANTHROPIC_API_KEY }}" | bunx wrangler secret put ANTHROPIC_API_KEY --env staging
            echo "${{ secrets.STAGING_GEMINI_API_KEY }}" | bunx wrangler secret put GEMINI_API_KEY --env staging
            echo "${{ secrets.STAGING_OPENAI_API_KEY }}" | bunx wrangler secret put OPENAI_API_KEY --env staging
            echo "${{ secrets.STAGING_CLICKHOUSE_PASSWORD }}" | bunx wrangler secret put CLICKHOUSE_PASSWORD --env staging
            echo "${{ secrets.STAGING_POSTHOG_API_KEY }}" | bunx wrangler secret put POSTHOG_API_KEY --env staging
            echo "${{ secrets.STAGING_POSTHOG_HOST }}" | bunx wrangler secret put POSTHOG_HOST --env staging
            echo "${{ secrets.STAGING_GOOGLE_ANALYTICS_MEASUREMENT_ID }}" | bunx wrangler secret put GOOGLE_ANALYTICS_MEASUREMENT_ID --env staging
            echo "${{ secrets.STAGING_GOOGLE_ANALYTICS_API_SECRET }}" | bunx wrangler secret put GOOGLE_ANALYTICS_API_SECRET --env staging

      - name: Notify staging deployment
        run: echo "âœ… Successfully deployed to staging at https://staging.mirascope.com"
